# -*- mode: makefile -*-
ROOT = ..
BINDIR = ${ROOT}/bin

intronProspector = ${BINDIR}/intronProspector

# Test run command in various ways and compares to expected output

diff = diff -u

basic_sam = input/test_basic.sam
basic_bam = output/test_basic.bam
multi_sam = input/test_multi.sam
fake10_star_sam = input/fake10.star.sam
fake10_hisat2_sam = input/fake10.hisat2.sam
fake10_missing_sam = input/fake10.missing.sam
fake10_fa = output/fake10_genome.fa
fake10_fai = output/fake10_genome.fa.fai

.PHONY: all
all:

.PHONY: test
test: testBasic testMulti testFake10 testRegress

###
# basic tests
##
testBasic: testBasic1 testBasic2 testBasic3 testBasic4 testBasic5

# basic unstranded
testBasic1: mkout
	${intronProspector} --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed --intron-calls=output/$@.introns.tsv --pass-through=output/$@.sam ${basic_sam}
	${diff} expected/$@.juncs.bed output/$@.juncs.bed
	${diff} expected/$@.introns.bed output/$@.introns.bed
	${diff} expected/$@.introns.tsv output/$@.introns.tsv
	${diff} ${basic_sam} output/$@.sam

# RF strandness
testBasic2: mkout
	${intronProspector} --strandness=RF --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed --intron-calls=output/$@.introns.tsv ${basic_sam}
	${diff} expected/$@.juncs.bed output/$@.juncs.bed
	${diff} expected/$@.introns.bed output/$@.introns.bed
	${diff} expected/$@.introns.tsv output/$@.introns.tsv

# testBasic1 with BAM
testBasic3: mkout ${basic_bam}
	${intronProspector} --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed --pass-through=output/$@.bam --intron-calls=output/$@.introns.tsv ${basic_bam}
	${diff} expected/testBasic1.juncs.bed output/$@.juncs.bed
	${diff} expected/testBasic1.introns.bed output/$@.introns.bed
	${diff} expected/$@.introns.tsv output/$@.introns.tsv
	samtools view -h output/$@.bam >output/$@.sam
	${diff} ${basic_sam} output/$@.sam

# test confidence score filter
testBasic4: mkout ${basic_bam}
	${intronProspector} --min-confidence-score=1.0 --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed --intron-calls=output/$@.introns.tsv ${basic_bam}
	${diff} expected/$@.juncs.bed output/$@.juncs.bed
	${diff} expected/$@.introns.bed output/$@.introns.bed
	${diff} expected/$@.introns.tsv output/$@.introns.tsv

# test exclude multi filter
testBasic5: mkout ${basic_bam}
	${intronProspector} --exclude=multi --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed --intron-calls=output/$@.introns.tsv ${basic_bam}
	${diff} expected/$@.juncs.bed output/$@.juncs.bed
	${diff} expected/$@.introns.bed output/$@.introns.bed
	${diff} expected/$@.introns.tsv output/$@.introns.tsv


###
# multi-introns per read tests
##
testMulti: testMulti1

testMulti1: mkout
	${intronProspector} --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed --intron-calls=output/$@.introns.tsv ${multi_sam}
	${diff} expected/$@.juncs.bed output/$@.juncs.bed
	${diff} expected/$@.introns.bed output/$@.introns.bed
	${diff} expected/$@.introns.tsv output/$@.introns.tsv

##
# fake10 tests
##
testFake10: testFake10a testFake10b testFake10c

# fake10 STAR mappings (SAM doesn't have strand)
testFake10a: mkout ${fake10_fa} ${fake10_fai}
	${intronProspector} --genome-fasta=${fake10_fa} --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed --intron-calls=output/$@.introns.tsv --pass-through=output/$@.sam --debug-trace=output/$@.debug.tsv ${fake10_star_sam}
	${diff} expected/$@.juncs.bed output/$@.juncs.bed
	${diff} expected/$@.introns.bed output/$@.introns.bed
	${diff} expected/$@.introns.tsv output/$@.introns.tsv
	${diff} expected/$@.debug.tsv output/$@.debug.tsv
	${diff} ${fake10_star_sam} output/$@.sam

# fake10 hisat2 mappings
testFake10b: mkout ${fake10_fa} ${fake10_fai}
	${intronProspector} --genome-fasta=${fake10_fa}  --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed --intron-calls=output/$@.introns.tsv --pass-through=output/$@.sam ${fake10_hisat2_sam}
	${diff} expected/$@.juncs.bed output/$@.juncs.bed
	${diff} expected/$@.introns.bed output/$@.introns.bed
	${diff} expected/$@.introns.tsv output/$@.introns.tsv
	${diff} ${fake10_hisat2_sam} output/$@.sam

# fake10 hisat2 mappings with missing target sequence
testFake10c: mkout ${fake10_fa} ${fake10_fai}
	${intronProspector} --genome-fasta=${fake10_fa} --skip-missing-targets --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed --intron-calls=output/$@.introns.tsv ${fake10_missing_sam} > output/$@.err 2>&1
	${diff} expected/$@.err output/$@.err
	${diff} expected/$@.juncs.bed output/$@.juncs.bed
	${diff} expected/$@.introns.bed output/$@.introns.bed
	${diff} expected/$@.introns.tsv output/$@.introns.tsv


testRegress: testSortBug

# bug where bed was incorrectly sort by always using anchors
testSortBug: mkout
	${intronProspector} --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed input/sort-bug.sam
	bedToBigBed -type=bed12 -tab output/$@.juncs.bed input/sort-bug.size output/$@.juncs.bigBed
	bedToBigBed -type=bed9 -tab output/$@.introns.bed input/sort-bug.size output/$@.introns.bigBed

###
# other rules
##
.PHONY: mkout
mkout:
	@mkdir -p output

output/%.bam: input/%.sam
	@mkdir -p output
	samtools view -b $< >$@.tmp
	mv -f $@.tmp $@

output/%.fa: input/%.fa
	@mkdir -p output
	cp $< output/$*.fa

output/%.fa.fai: output/%.fa
	samtools faidx $<

.PHONY: clean
clean:
	rm -rf output

.PHONY: distclean
distclean: clean
	rm -f Makefile
