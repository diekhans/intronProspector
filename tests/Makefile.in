# -*- mode: makefile -*-
ROOT = ..
BINDIR = ${ROOT}/bin

intronProspector = ${BINDIR}/intronProspector
intronProspectorMerge = ${BINDIR}/intronProspectorMerge

# Test run command in various ways and compares to expected output

diff = diff -u

basic_sam = input/test_basic.sam
basic_bam = output/test_basic.bam
multi_sam = input/test_multi.sam
fake10_star_sam = input/fake10.star.sam
fake10_hisat2_sam = input/fake10.hisat2.sam
fake10_missing_sam = input/fake10.missing.sam
fake10_fa = output/fake10_genome.fa
fake10_fai = output/fake10_genome.fa.fai
ont_sam = input/ont.sam

define diff_out
	${diff} expected/$@.introns.tsv output/$@.introns.tsv
	${diff} expected/$@.juncs.bed output/$@.juncs.bed
	${diff} expected/$@.introns.bed output/$@.introns.bed
endef


.PHONY: all
all:

.PHONY: test
test: intronProspctorTests intronProspctorMergeTests


#####
# intronProspctor tests
#####
intronProspctorTests: basicTests multiTests fake10Tests regressTests ontTests

###
# basic tests
##
basicTests: testBasic1 testBasic2 testBasic3 testBasic4 testBasic5

# basic unstranded
testBasic1: mkout
	${intronProspector} --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed --intron-calls=output/$@.introns.tsv --pass-through=output/$@.sam ${basic_sam}
	${diff_out}
	${diff} ${basic_sam} output/$@.sam

# RF strandness
testBasic2: mkout
	${intronProspector} --strandness=RF --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed --intron-calls=output/$@.introns.tsv ${basic_sam}
	${diff_out}

# testBasic1 with BAM
testBasic3: mkout ${basic_bam}
	${intronProspector} --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed --pass-through=output/$@.bam --intron-calls=output/$@.introns.tsv ${basic_bam}
	${diff_out}
	samtools view -h --no-PG output/$@.bam >output/$@.sam
	${diff} ${basic_sam} output/$@.sam

# test confidence score filter
testBasic4: mkout ${basic_bam}
	${intronProspector} --min-confidence-score=1.0 --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed --intron-calls=output/$@.introns.tsv ${basic_bam}
	${diff_out}

# test exclude multi filter
testBasic5: mkout ${basic_bam}
	${intronProspector} --exclude=multi --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed --intron-calls=output/$@.introns.tsv ${basic_bam}
	${diff_out}


###
# multi-introns per read tests
##
multiTests: testMulti1

testMulti1: mkout
	${intronProspector} --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed --intron-calls=output/$@.introns.tsv ${multi_sam}
	${diff_out}
	bedToBigBed output/$@.juncs.bed input/test_multi.size output/$@.juncs.bigBed
	bedToBigBed output/$@.introns.bed input/test_multi.size output/$@.introns.bigBed

##
# fake10 tests
##
fake10Tests: testFake10a testFake10b testFake10c

# fake10 STAR mappings (SAM doesn't have strand)
testFake10a: mkout ${fake10_fa} ${fake10_fai}
	${intronProspector} --genome-fasta=${fake10_fa} --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed --intron-calls=output/$@.introns.tsv --pass-through=output/$@.sam --debug-trace=output/$@.debug.tsv ${fake10_star_sam}
	${diff_out}
	${diff} expected/$@.debug.tsv output/$@.debug.tsv
	${diff} ${fake10_star_sam} output/$@.sam

# fake10 hisat2 mappings
testFake10b: mkout ${fake10_fa} ${fake10_fai}
	${intronProspector} --genome-fasta=${fake10_fa}  --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed --intron-calls=output/$@.introns.tsv --pass-through=output/$@.sam ${fake10_hisat2_sam}
	${diff_out}
	${diff} ${fake10_hisat2_sam} output/$@.sam

# fake10 hisat2 mappings with missing target sequence
testFake10c: mkout ${fake10_fa} ${fake10_fai}
	${intronProspector} --genome-fasta=${fake10_fa} --skip-missing-targets --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed --intron-calls=output/$@.introns.tsv ${fake10_missing_sam} > output/$@.err 2>&1
	${diff} expected/$@.err output/$@.err
	${diff_out}


regressTests: testSortBug

# bug where bed was incorrectly sorted
testSortBug: mkout
	${intronProspector} --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed input/sort-bug.sam
	bedToBigBed -type=bed12 -tab output/$@.juncs.bed input/sort-bug.size output/$@.juncs.bigBed
	bedToBigBed -type=bed9 -tab output/$@.introns.bed input/sort-bug.size output/$@.introns.bigBed

#####
# intronProspctorMerge tests
#####
intronProspctorMergeTests: testBasic134Merge testFake10abMerge

testBasic134Merge: mkout
	${intronProspectorMerge} --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed --intron-calls=output/$@.introns.tsv \
	    expected/testBasic1.introns.tsv expected/testBasic3.introns.tsv expected/testBasic4.introns.tsv
	${diff_out}

testFake10abMerge: mkout
	${intronProspectorMerge} --intron-calls=output/$@.introns.tsv \
	    expected/testFake10a.introns.tsv expected/testFake10b.introns.tsv
	${diff} expected/$@.introns.tsv output/$@.introns.tsv

##
# ONT tests
##
ontTests: testOnt1

testOnt1: mkout
	${intronProspector} --junction-bed=output/$@.juncs.bed --intron-bed=output/$@.introns.bed --intron-calls=output/$@.introns.tsv --pass-through=output/$@.sam ${ont_sam}
	${diff_out}
	${diff} ${basic_sam} output/$@.sam


###
# other rules
##
.PHONY: mkout
mkout:
	@mkdir -p output

output/%.bam: input/%.sam
	@mkdir -p output
	samtools view -b --no-PG $< >$@.tmp
	mv -f $@.tmp $@

output/%.fa: input/%.fa
	@mkdir -p output
	cp $< output/$*.fa

output/%.fa.fai: output/%.fa
	samtools faidx $<

.PHONY: clean
clean:
	rm -rf output

.PHONY: distclean
distclean: clean
	rm -f Makefile
